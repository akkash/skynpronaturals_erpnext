[
 {
  "docstatus": 0, 
  "doctype": "Custom Script", 
  "dt": "Sales Invoice", 
  "modified": "2017-01-20 12:04:44.272334", 
  "name": "Sales Invoice-Client", 
  "script": "frappe.ui.form.on(\"Sales Invoice\", \"refresh\", function(frm) {\n    if (frappe.user.name == \"assam@spntest.com\") {\n        frappe.model.get_value(\"SPN Settings\", \"SPN Settings\", \"spn_transit_warehouse\", function(r){\n            var r = r;\n            frm.set_query(\"spn_warehouse\", function() {\n                return {\n                    query: \"skynpronaturals_erpnext.api.se_get_allowed_warehouses\",\n                    filters:[\n                        [\"Warehouse\", \"name\", \"not in\", \n                            [\n                                \"(WEST BENGAL, Kolkata) Bellezimo Professionale Products Pvt. Ltd. C/o. Alloy Associates - SPN\" ,\n                                \"(MAHARASHTRA, Bhiwandi) Bellezimo Professionale Products Pvt. Ltd. C/o. Kotecha Clearing & Forwarding Pvt. Ltd.  - SPN\",\n                                r.spn_transit_warehouse\n                            ]\n                        ]\n                    ]\n                }\n            });\n            frm.fields_dict.items.grid.get_field('warehouse').get_query = function() {\n                return {\n                    query: \"skynpronaturals_erpnext.api.se_get_allowed_warehouses\",\n                    filters:[\n                        [\"Warehouse\", \"name\", \"not in\", \n                            [\n                                \"(WEST BENGAL, Kolkata) Bellezimo Professionale Products Pvt. Ltd. C/o. Alloy Associates - SPN\" ,\n                                \"(MAHARASHTRA, Bhiwandi) Bellezimo Professionale Products Pvt. Ltd. C/o. Kotecha Clearing & Forwarding Pvt. Ltd.  - SPN\",\n                                r.spn_transit_warehouse\n                            ]\n                        ]\n                    ]\n                }\n            }\n        });\n    }\n});\n\nfrappe.ui.form.on(\"Sales Invoice Item\", \"item_code\", function(frm, cdt, cdn) {\n    var d = locals[cdt][cdn];\n    d[\"warehouse\"] = cur_frm.doc.spn_warehouse;\n});\n\nfrappe.ui.form.on(\"Sales Invoice\", \"spn_warehouse\", function(frm) {\n    if(frm.doc.spn_warehouse && frm.doc.territory && frm.doc.customer_group) {\n        items = frm.doc.items;\n        for (var i=0; i <= items.length - 1; i++) {\n            items[i].warehouse = cur_frm.doc.spn_warehouse;\n        }\n        \n        //Fetch and set letterhead\n        frappe.call({\n            method: \"skynpronaturals_erpnext.api.get_spn_letter_head\",\n            args: {spn_warehouse: frm.doc.spn_warehouse }, \n            callback: function(r) {\n                if (!r.exc) {\n                    cur_frm.set_value(\"letter_head\", r.message);\n                } else {\n                    frappe.msgprint(\"Check letterhead field in selected Warehouse.\")\n                }\n            }\n        });\n        \n        frappe.call({\n            method: \"skynpronaturals_erpnext.api.get_naming_series\",\n            args: { \n             \"spn_warehouse\": frm.doc.spn_warehouse,\n             \"cust_ter\": frm.doc.territory,\n             \"cust_group\": frm.doc.customer_group\n            },\n            callback: function(r){\n                if (r) {\n                    cur_frm.set_value(\"naming_series\", r.message);\n                }\n            }\n        });\n        \n        //Fetch terms by territory and set.\n        frappe.call({\n            method: \"skynpronaturals_erpnext.api.get_terms_by_warehouse_state\",\n            args: { \n             \"spn_warehouse\": frm.doc.spn_warehouse\n            },\n            callback: function(r){\n                if (r) {\n                    cur_frm.set_value(\"tc_name\", r.message);\n                }\n            }\n        });\n    }\n});", 
  "script_type": "Client"
 }, 
 {
  "docstatus": 0, 
  "doctype": "Custom Script", 
  "dt": "Purchase Receipt", 
  "modified": "2017-01-19 14:40:46.251157", 
  "name": "Purchase Receipt-Client", 
  "script": "frappe.ui.form.on(\"Purchase Receipt\", \"refresh\", function(frm) {\n    frappe.model.get_value(\"SPN Settings\", \"SPN Settings\", \"spn_transit_warehouse\", function(r){\n        var r = r;\n        frm.set_query(\"spn_warehouse\", function() {\n            return {\n                query: \"skynpronaturals_erpnext.api.se_get_allowed_warehouses\",\n                filters:[\n                    [\"Warehouse\", \"name\", \"not in\", \n                        [\n                            \"(WEST BENGAL, Kolkata) Bellezimo Professionale Products Pvt. Ltd. C/o. Alloy Associates - SPN\" ,\n                            \"(MAHARASHTRA, Bhiwandi) Bellezimo Professionale Products Pvt. Ltd. C/o. Kotecha Clearing & Forwarding Pvt. Ltd.  - SPN\",\n                            r.spn_transit_warehouse\n                        ]\n                    ]\n                ]\n            }\n        });\n        frm.fields_dict.items.grid.get_field('warehouse').get_query = function() {\n            return {\n                query: \"skynpronaturals_erpnext.api.se_get_allowed_warehouses\",\n                filters:[\n                    [\"Warehouse\", \"name\", \"not in\", \n                        [\n                            \"(WEST BENGAL, Kolkata) Bellezimo Professionale Products Pvt. Ltd. C/o. Alloy Associates - SPN\" ,\n                            \"(MAHARASHTRA, Bhiwandi) Bellezimo Professionale Products Pvt. Ltd. C/o. Kotecha Clearing & Forwarding Pvt. Ltd.  - SPN\",\n                            r.spn_transit_warehouse\n                        ]\n                    ]\n                ]\n            }\n        }\n        frm.fields_dict.items.grid.get_field('rejected_warehouse').get_query = function() {\n            return {\n                query: \"skynpronaturals_erpnext.api.se_get_allowed_warehouses\",\n                filters:[\n                    [\"Warehouse\", \"name\", \"not in\", \n                        [\n                            \"(WEST BENGAL, Kolkata) Bellezimo Professionale Products Pvt. Ltd. C/o. Alloy Associates - SPN\" ,\n                            \"(MAHARASHTRA, Bhiwandi) Bellezimo Professionale Products Pvt. Ltd. C/o. Kotecha Clearing & Forwarding Pvt. Ltd.  - SPN\",\n                            r.spn_transit_warehouse\n                        ]\n                    ]\n                ]\n            }\n        }\n    });\n});\n\nfrappe.ui.form.on(\"Purchase Receipt Item\", \"item_code\", function(frm, cdt, cdn) {\n\tvar d = locals[cdt][cdn];\n\td[\"warehouse\"] = cur_frm.doc.spn_warehouse;\n});\n\nfrappe.ui.form.on(\"Purchase Receipt\", \"spn_warehouse\", function(frm) {\n    if(frm.doc.spn_warehouse) {\n        items = frm.doc.items;\n        for (var i=0; i <= items.length - 1; i++) {\n            items[i].warehouse = cur_frm.doc.spn_warehouse;\n        }\n        \n        //Fetch and set letterhead\n        frappe.call({\n            method: \"skynpronaturals_erpnext.api.get_spn_letter_head\",\n            args: {spn_warehouse: frm.doc.spn_warehouse }, \n            callback: function(r) {\n                if (!r.exc) {\n                    cur_frm.set_value(\"letter_head\", r.message);\n                } else {\n                    frappe.msgprint(\"Check letterhead field in selected Warehouse.\")\n                }\n            }\n        });\n    }\n});", 
  "script_type": "Client"
 }, 
 {
  "docstatus": 0, 
  "doctype": "Custom Script", 
  "dt": "Stock Entry", 
  "modified": "2017-01-23 01:52:47.822787", 
  "name": "Stock Entry-Client", 
  "script": "frappe.ui.form.on(\"Stock Entry\", \"onload\", function(frm) {\n    frm.set_df_property(\"spn_to_warehouse\", \"hidden\", 1);\n});\n\nfrappe.ui.form.on(\"Stock Entry\", \"refresh\", function(frm) {\n    //var condition = (((frm.doc.docstatus == 0)  || frm.doc.__islocal) || frm.doc.spn_linked);\n    var condition = (!frm.doc.spn_linked_transit_entry) \n        && (frm.doc.spn_stock_entry_type == \"Skynpro\") \n        && (frm.doc.purpose ==\"Material Transfer\") \n        && ((frm.doc.docstatus == 0) || (frm.doc.__islocal));\n\n    if (condition) {\n        frm.add_custom_button(__(\"Set Details from Transit Entry\"), function() {\n           var p = frappe.prompt([\n                {\n                    'fieldname': 'stock_entry', \n                    'fieldtype': 'Link', \n                    'options': 'Stock Entry',\n                    'label': 'Stock Entry',\n                    'get_query': function() {\n                        return {\n                            filters: {\"spn_linked_transit_entry\":\"\", \"docstatus\":\"1\"}\n                        }\n                    }\n                }\n            ],\n            function(value){\n                console.log(value);\n                set_details_from_transit_entry(frm, value[\"stock_entry\"]);\n            },\n            'Select Transit Entry',\n            'Select'\n            )\n        });\n    }\n\n    //Set query filter for specific users\n    if (frappe.user.name == \"assam@spntest.com\") {\n        frm.set_query(\"spn_to_warehouse\", function() {\n            return {\n                query: \"skynpronaturals_erpnext.api.se_get_allowed_warehouses\",\n                filters:[\n                    [\"Warehouse\", \"name\", \"in\", \n                        [\n                            \"(WEST BENGAL, Kolkata) Bellezimo Professionale Products Pvt. Ltd. C/o. Alloy Associates - SPN\" ,\n                            \"(MAHARASHTRA, Bhiwandi) Bellezimo Professionale Products Pvt. Ltd. C/o. Kotecha Clearing & Forwarding Pvt. Ltd.  - SPN\"\n                        ]\n                    ]\n                ]\n            }\n        });\n        frm.set_query(\"from_warehouse\", function() {\n            return {\n                query: \"skynpronaturals_erpnext.api.se_get_allowed_warehouses\",\n                filters:[\n                    [\"Warehouse\", \"name\", \"not in\", \n                        [\n                            \"(WEST BENGAL, Kolkata) Bellezimo Professionale Products Pvt. Ltd. C/o. Alloy Associates - SPN\",\n                            \"(MAHARASHTRA, Bhiwandi) Bellezimo Professionale Products Pvt. Ltd. C/o. Kotecha Clearing & Forwarding Pvt. Ltd.  - SPN\"\n                        ]\n                    ]\n                ]\n            }\n        });\n        frm.set_query(\"spn_rejected_warehouse\", \"items\", function(doc, cdt, cdn) {\n\t        return {\n\t            query: \"skynpronaturals_erpnext.api.se_get_allowed_warehouses\",\n\t            filters: {\"name\": \"Reject Warehouse for Guwahati, Assam - SPN\"}\n\t        }\n\t    });\n\t} else if (frappe.user.name == \"maharashtra@spntest.com\") {\n\t\tfrm.set_query(\"spn_to_warehouse\", function() {\n            return {\n                query: \"skynpronaturals_erpnext.api.se_get_allowed_warehouses\",\n                filters:[\n                    [\"Warehouse\", \"name\", \"in\", \n                        [\n                            \"(WEST BENGAL, Kolkata) Bellezimo Professionale Products Pvt. Ltd. C/o. Alloy Associates - SPN\" ,\n                            \"(ASSAM, Guwahati) Bellezimo Professionale Products Pvt. Ltd. C/o. Siddhi Vinayak Agencies - SPN\"\n                        ]\n                    ]\n                ]\n            }\n        });\n        frm.set_query(\"from_warehouse\", function() {\n            return {\n                query: \"skynpronaturals_erpnext.api.se_get_allowed_warehouses\",\n                filters:[\n                    [\"Warehouse\", \"name\", \"not in\", \n                        [\n                            \"(WEST BENGAL, Kolkata) Bellezimo Professionale Products Pvt. Ltd. C/o. Alloy Associates - SPN\",\n                            \"(ASSAM, Guwahati) Bellezimo Professionale Products Pvt. Ltd. C/o. Siddhi Vinayak Agencies - SPN\"\n                        ]\n                    ]\n                ]\n            }\n        });\n        frm.set_query(\"spn_rejected_warehouse\", \"items\", function(doc, cdt, cdn) {\n\t        return {\n\t            query: \"skynpronaturals_erpnext.api.se_get_allowed_warehouses\",\n\t            filters: {\"name\": \"Reject Warehouse for Bhiwandi, Maharashtra - SPN\"}\n\t        }\n\t    });\n\t}\n\n\t//Transit warehouse\n    frappe.model.get_value(\"SPN Settings\", \"SPN Settings\", \"spn_transit_warehouse\", function(r){\n        var r = r; \n        frm.set_query(\"to_warehouse\", function() {\n            if(cur_frm.doc.purpose=\"Material Transfer\" && cur_frm.doc.spn_stock_entry_type == \"Skynpro\") {\n                return {\n                    query: \"skynpronaturals_erpnext.api.se_get_allowed_warehouses\",\n                    filters:[\n                        [\"Warehouse\", \"name\", \"in\", \n                            [\n                                r.spn_transit_warehouse\n                            ]\n                        ]\n                    ]\n                }\n            } else {\n                return {\n                    query: \"skynpronaturals_erpnext.api.se_get_allowed_warehouses\"\n                }\n            }\n        });\n    });\n});\n\n\nfrappe.ui.form.on(\"Stock Entry\", \"spn_to_warehouse\", function(frm) {\n    if(frm.doc.spn_to_warehouse) {\n        items = frm.doc.items;\n        for (var i=0; i <= items.length - 1; i++) {\n            items[i].spn_t_warehouse = cur_frm.doc.spn_to_warehouse;\n        }\n    }\n});\n\nfrappe.ui.form.on(\"Stock Entry\", \"from_warehouse\", function(frm) {\n    if(frm.doc.from_warehouse) {\n        frappe.call({\n            method: \"skynpronaturals_erpnext.api.get_spn_letter_head\",\n            args: {spn_warehouse: cur_frm.doc.from_warehouse }, \n            callback: function(r) {\n                if (!r.exc) {\n                    cur_frm.set_value(\"letter_head\", r.message);\n                } else {\n                    frappe.msgprint(\"Check letterhead field in selected Warehouse.\")\n                }\n            }\n        });\n    }\n});\n\nfrappe.ui.form.on(\"Stock Entry\", \"purpose\", function(frm) {\n    set_destination_warehouse(frm);\n    if (cur_frm.doc.purpose == \"Material Transfer\") {\n        cur_frm.set_value(\"spn_stock_entry_type\", \"Skynpro\");\n    } else {\n        cur_frm.set_value(\"spn_stock_entry_type\", \"Default\");\n    }\n    cur_frm.refresh();\n});\n\nfrappe.ui.form.on(\"Stock Entry\", \"spn_stock_entry_type\", function(frm) {\n    set_destination_warehouse(frm);\n});\n\nfrappe.ui.form.on(\"Stock Entry Detail\", \"spn_qty_lost\", function(frm, cdt, cdn) {\n    recalculate_item_qty(frm,cdt,cdn);\n});\nfrappe.ui.form.on(\"Stock Entry Detail\", \"spn_rejected_qty\", function(frm, cdt, cdn) {\n    recalculate_item_qty(frm,cdt,cdn);\n});\n\n//Helpers\nfunction set_destination_warehouse(frm){\n    if (frm.doc.purpose == \"Material Transfer\") {\n        if (frm.doc.spn_stock_entry_type == \"Skynpro\") {\n            frm.set_df_property(\"spn_to_warehouse\", \"hidden\", 0);\n            frappe.model.get_value(\"SPN Settings\", \"SPN Settings\", \"spn_transit_warehouse\", function(r){                         \n                cur_frm.set_value(\"to_warehouse\", r.spn_transit_warehouse);\n            });\n        } else {\n            frm.set_df_property(\"spn_to_warehouse\", \"hidden\", 1);\n            cur_frm.set_value(\"to_warehouse\", \"\");\n        }\n    } else {\n        frm.set_df_property(\"spn_to_warehouse\", \"hidden\", 1);\n        cur_frm.set_value(\"to_warehouse\", \"\");\n    }\n}\n\n//Details from transit entry\nfunction set_details_from_transit_entry(frm, transit_entry_name) {\n    items = [];\n    frappe.call({\n        method: \"skynpronaturals_erpnext.api.get_details_from_transit_entry\",\n        args: { \n            \"transit_entry_name\" : transit_entry_name \n        },\n        callback: function(r) {\n            console.log(\"Details fetched\", r);\n            //Set Type\n            //cur_frm.set_value(\"purpose\", \"Material Transfer\");\n            cur_frm.set_value(\"spn_stock_entry_type\", \"Default\");\n\n            //Set Items\n            cur_frm.set_value(\"items\", []); //Clear existing items first (blank row/items from prev fetch).\n            for (i=0;i<=r.message.items.length-1; i++) {\n                row = frappe.model.add_child(cur_frm.doc, \"Stock Entry Detail\", \"items\");\n                row.item_code = r.message.items[i].item_code;\n                row.item_name = r.message.items[i].item_name;\n                row.qty = r.message.items[i].qty;\n                row.transfer_qty = r.message.items[i].transfer_qty;\n                row.uom = r.message.items[i].uom;\n                row.basic_rate = r.message.items[i].basic_rate;\n                row.basic_amount = r.message.items[i].basic_amount;\n                row.additional_cost = r.message.items[i].additional_cost;\n                row.valuation_rate = r.message.items[i].valuation_rate;\n                row.amount = r.message.items[i].amount;\n                row.conversion_factor = r.message.items[i].conversion_factor;\n                row.expense_account = r.message.items[i].expense_account;\n                row.cost_center = r.message.items[i].cost_center;\n                refresh_field(\"items\");\n            }\n\n            //Set Default warehouses here. Cause cascade in items.\n            frappe.model.get_value(\"SPN Settings\", \"SPN Settings\", \"spn_transit_warehouse\", function(rval){                      \n                cur_frm.set_value(\"from_warehouse\", rval.spn_transit_warehouse);\n            });\n            \n            cur_frm.set_value(\"to_warehouse\", r.message.destination_warehouse);\n            \n            //Link selected SE to current SE.\n            cur_frm.set_value(\"spn_linked_transit_entry\", transit_entry_name);\n\n            refresh_field(\"items\");\n        }\n    });\n}\n\nfunction create_transit_loss_stock_entry_on_submit(frm) {\n    var items_with_transit_loss = frm.doc.items.filter(function(i) { i.spn_loss_qty > 0.0 });\n    if (items_with_transit_loss.length > 0) {\n        //Create transit entry with stock loss\n        frappe.call({\n            method: \"refreshednow_erpnext.api.create_transit_loss_stock_entry\",\n            args: { \"created_against\" : frm.doc.name },\n            callback: function(r) {\n                if (!r.exc) {\n                    show_alert(\"Transit loss entry created (\" + r.message + \")\");\n                }\n            }\n        })\n    }\n}\n\nfunction recalculate_item_qty(frm,cdt,cdn) {\n    var d = locals[cdt][cdn];\n    frappe.db.get_value(\"Stock Entry Detail\", \n        filters={\"parent\": cur_frm.doc.spn_linked_transit_entry, \"item_code\": d[\"item_code\"]}, \n        fieldname=\"qty\",\n        function(r) {\n            d[\"qty\"] = r.qty - ( (d[\"spn_rejected_qty\"] || 0.0) + (d[\"spn_qty_lost\"] || 0.0));\n            refresh_field(\"items\"); \n    });\n}", 
  "script_type": "Client"
 }
]